# Настройка OpenRouter LLM API

## О OpenRouter

OpenRouter - это сервис, предоставляющий единый API для доступа к различным LLM моделям (OpenAI, Anthropic, Google, Meta и др.). Имеет бесплатные модели и работает в России.

**Преимущества:**
- ✅ Работает в России (может потребоваться VPN для регистрации, но API работает)
- ✅ OpenAI-совместимый API (легкая интеграция)
- ✅ Бесплатные модели доступны
- ✅ Доступ к множеству моделей от разных провайдеров
- ✅ Не требует кастомной интеграции

## Регистрация и получение API ключа

### Шаг 1: Откройте сайт OpenRouter

1. Перейдите на https://openrouter.ai/
2. Изучите доступные модели: https://openrouter.ai/models

### Шаг 2: Регистрация

1. **Найдите кнопку регистрации:**
   - Обычно "Sign Up" или "Get Started" в правом верхнем углу
   - Или перейдите напрямую: https://openrouter.ai/auth/signup

2. **Выберите способ регистрации:**
   - Через Google аккаунт (рекомендуется)
   - Через GitHub
   - Через email (может потребоваться VPN)

3. **Заполните форму (если через email):**
   - Email
   - Пароль
   - Подтвердите email

4. **Войдите в аккаунт**

### Шаг 3: Получение API ключа

1. **Перейдите в раздел API Keys:**
   - После входа найдите "Keys" в меню
   - Или перейдите напрямую: https://openrouter.ai/keys

2. **Создайте новый API ключ:**
   - Нажмите "Create Key" или "Создать ключ"
   - Укажите название ключа (например, "RAG Bot")
   - Выберите права доступа (обычно "Read" достаточно)

3. **Сохраните ключ:**
   - ⚠️ **ВАЖНО**: API ключ отображается только один раз при создании
   - Скопируйте ключ и сохраните его в безопасном месте
   - Не делитесь ключом публично

### Шаг 4: Выбор бесплатной модели

OpenRouter предоставляет бесплатные модели с суффиксом `:free`:

- `meta-llama/llama-3.1-8b-instruct:free` (рекомендуется)
- `google/gemma-2-2b-it:free`
- `microsoft/phi-3-mini-128k-instruct:free`
- `qwen/qwen-2-7b-instruct:free`

Полный список бесплатных моделей: https://openrouter.ai/models?order=newest&supported_parameters=free

## Настройка в проекте

### 1. Обновите файл `.env`

Добавьте следующие переменные:

```env
# OpenRouter настройки
LLM_PROVIDER=openai
OPENAI_BASE_URL=https://openrouter.ai/api/v1
LLM_MODEL=meta-llama/llama-3.2-3b-instruct:free
OPENAI_API_KEY=your_openrouter_api_key_here

# RAGAS LLM (использует те же настройки)
RAGAS_LLM_MODEL=meta-llama/llama-3.1-8b-instruct:free
```

**Важно:**
- `LLM_PROVIDER=openai` - используем стандартный OpenAI-совместимый провайдер
- `OPENAI_BASE_URL=https://openrouter.ai/api/v1` - endpoint OpenRouter
- `LLM_MODEL` - выберите модель (рекомендуется с `:free` для бесплатного использования)
- `OPENAI_API_KEY` - ваш API ключ от OpenRouter

### 2. Дополнительные настройки (опционально)

OpenRouter поддерживает дополнительные заголовки для указания провайдера:

```env
# Опционально: укажите HTTP заголовок для OpenRouter
# Это можно сделать через переменную окружения, но обычно не требуется
```

## Проверка работы

### 1. Тест LLM:

```bash
uv run python scripts/test_llm.py
```

Если все настроено правильно, вы должны увидеть успешный ответ от OpenRouter.

### 2. Запуск бота:

```bash
make run
```

Отправьте сообщение боту в Telegram - он должен отвечать через OpenRouter.

### 3. Запуск evaluation:

```bash
make reindex-and-evaluate
```

Evaluation будет использовать OpenRouter для генерации ответов и вычисления метрик.

## Преимущества OpenRouter

1. **Простая интеграция**: OpenAI-совместимый API означает, что не нужны изменения в коде
2. **Бесплатные модели**: Есть бесплатные модели с суффиксом `:free`
3. **Разнообразие моделей**: Доступ к моделям от разных провайдеров
4. **Гибкость**: Можно легко переключаться между моделями

## Известные ограничения

1. **Rate limits**: Бесплатные модели имеют строгие ограничения:
   - **20 запросов в минуту** для бесплатных моделей
   - **50 запросов в день** для пользователей, не пополнявших баланс
   - При превышении лимита возвращается ошибка **429 Too Many Requests**
   - **Важно**: Большое количество автоматических retry при 429 ошибках только усугубляет ситуацию
   - В коде настроено умеренное количество retry (3 попытки) с exponential backoff
   - Retry в OpenAI клиенте для RAGAS отключены (`max_retries=0`), чтобы избежать быстрых повторных попыток
2. **VPN для регистрации**: Может потребоваться VPN для регистрации, но API работает без VPN
3. **Латентность**: Может быть немного медленнее, чем прямые API провайдеров

## Решение проблем с Rate Limiting

Если вы видите множество ошибок `429 Too Many Requests` в логах:

1. **Убедитесь, что используются правильные настройки**:
   ```env
   EVALUATION_MAX_CONCURRENT=1  # Последовательная обработка (обязательно!)
   EVALUATION_DELAY_BETWEEN_REQUESTS=5.0  # Минимум 3 секунды (20 запросов/мин), но лучше 5-10
   ```

2. **Увеличьте задержку между запросами** (если проблемы продолжаются):
   ```env
   EVALUATION_DELAY_BETWEEN_REQUESTS=10.0  # Рекомендуется 10 секунд для бесплатных моделей
   # Это даст ~6 запросов в минуту, что безопасно для лимита 20/мин
   ```

3. **Проверьте ваши лимиты**:
   ```bash
   curl -H "Authorization: Bearer YOUR_API_KEY" https://openrouter.ai/api/v1/key
   ```
   Это покажет текущие лимиты и оставшиеся кредиты.

4. **Важно**: При 429 ошибках код автоматически делает паузы:
   - Первая попытка после 429: 60 секунд
   - Вторая попытка: 120 секунд
   - Третья попытка: 240 секунд
   
   Это нормально и помогает избежать дальнейших rate limit ошибок.

5. **Для RAGAS evaluation**:
   - Retry в OpenAI клиенте отключены (`max_retries=0`), чтобы избежать быстрых повторных попыток
   - RAGAS сам обрабатывает ошибки, но может делать множество параллельных запросов
   - Если проблемы продолжаются, используйте `EVALUATION_FAST_MODE=true` для уменьшения количества запросов

6. **Рассмотрите платный план**:
   - Если ваш проект требует большого количества запросов, платный план дает более высокие лимиты
   - Информация о тарифах: https://openrouter.ai/docs/api-reference/limits

3. **Используйте быстрый режим evaluation** (меньше запросов к LLM):
   ```env
   EVALUATION_FAST_MODE=true  # Только основные метрики
   ```

4. **Проверьте лимиты вашего аккаунта**:
   - Перейдите на https://openrouter.ai/keys
   - Проверьте текущие лимиты для вашего API ключа
   - Рассмотрите возможность перехода на платный план для увеличения лимитов

## Платные модели

Если бесплатных моделей недостаточно, можно использовать платные:

- `openai/gpt-4o-mini` - быстрая и недорогая модель от OpenAI
- `anthropic/claude-3-haiku` - быстрая модель от Anthropic
- `google/gemini-pro-1.5` - модель от Google

Цены и доступность: https://openrouter.ai/models

## Документация

- Сайт OpenRouter: https://openrouter.ai/
- Документация API: https://openrouter.ai/docs
- Список моделей: https://openrouter.ai/models
- Бесплатные модели: https://openrouter.ai/models?order=newest&supported_parameters=free

## Альтернативы

Если OpenRouter не работает, можно использовать:
- **LLMost**: https://llmost.ru/ (российский, OpenAI-совместимый)
- **OpenGate**: https://opengatellm.ru/ (российский, OpenAI-совместимый)
- **GigaChat**: https://developers.sber.ru/gigachat (российский, требует кастомную интеграцию)

