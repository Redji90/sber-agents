# Настройка Vosk для распознавания речи

Vosk - это бесплатная библиотека для офлайн распознавания речи с открытым исходным кодом. Она работает локально, не требует интернет-соединения и API ключей.

## Преимущества Vosk

- ✅ **Бесплатно** - полностью бесплатное использование
- ✅ **Офлайн** - работает без интернета
- ✅ **Приватность** - аудио не отправляется на внешние серверы
- ✅ **Хорошая поддержка русского языка**
- ✅ **Быстрая работа** после загрузки модели

## Установка

### 1. Установите зависимости

Зависимости уже добавлены в `pyproject.toml`. Установите их:

```bash
uv sync
```

или

```bash
pip install vosk pydub
```

### 2. Установите FFmpeg (требуется для конвертации аудио)

Vosk работает с WAV файлами, а Telegram отправляет OGG Opus. Для конвертации используется `pydub`, которому нужен FFmpeg.

#### Windows:

1. Скачайте FFmpeg: https://www.gyan.dev/ffmpeg/builds/
2. Распакуйте архив
3. Добавьте путь к `bin` в переменную окружения PATH
   - Например: `C:\ffmpeg\bin`
4. Проверьте установку:
   ```bash
   ffmpeg -version
   ```

Или используйте chocolatey:
```bash
choco install ffmpeg
```

#### Linux (Ubuntu/Debian):

```bash
sudo apt update
sudo apt install ffmpeg
```

#### macOS:

```bash
brew install ffmpeg
```

### 3. Скачайте модель Vosk

Vosk требует предобученную модель для распознавания. Для русского языка доступны несколько моделей:

**Рекомендуемые модели для русского языка:**

1. **vosk-model-small-ru-0.22** (~45 МБ)
   - Быстрая загрузка
   - Хорошая точность для коротких сообщений
   - Рекомендуется для начала

2. **vosk-model-ru-0.42** (~1.8 ГБ)
   - Высокая точность
   - Лучше для длинных сообщений
   - Требует больше памяти

3. **vosk-model-ru-0.10** (~1.5 ГБ)
   - Старая версия, но стабильная

**Скачать модели:**

1. Перейдите на https://alphacephei.com/vosk/models
2. Найдите модель для русского языка
3. Скачайте и распакуйте архив
4. Запомните путь к папке с моделью

**Пример структуры после распока:**
```
vosk-model-small-ru-0.22/
├── am/
├── graph/
├── conf/
└── ...
```

## Настройка

### 1. Обновите config.yaml

Добавьте настройки Vosk в секцию `speech`:

```yaml
speech:
  provider: "vosk"  # Измените на vosk
  model_path: "C:/path/to/vosk-model-small-ru-0.22"  # Путь к модели
  language: "ru"  # Язык (используется для других провайдеров)
```

**Важно:** Укажите полный путь к папке с моделью (не к файлу внутри папки).

### 2. Или используйте переменные окружения

Создайте файл `.env`:

```env
SPEECH_PROVIDER=vosk
SPEECH_MODEL_PATH=C:/path/to/vosk-model-small-ru-0.22
SPEECH_LANGUAGE=ru
```

## Проверка работы

1. Запустите бота:
   ```bash
   uv run python -m bot.main
   ```

2. Отправьте голосовое сообщение боту

3. Проверьте логи - должно быть:
   ```
   INFO:__main__:Using Vosk model: C:/path/to/vosk-model-small-ru-0.22
   INFO:__main__:Loading Vosk model from C:/path/to/vosk-model-small-ru-0.22...
   INFO:__main__:Vosk model loaded successfully
   INFO:__main__:Vosk transcription result: ваш текст
   ```

## Устранение проблем

### Ошибка: "Vosk model not found"

**Решение:**
- Проверьте, что путь к модели указан правильно
- Убедитесь, что указан путь к папке с моделью, а не к файлу
- Используйте абсолютный путь (не относительный)

### Ошибка: "ffmpeg not found" или проблемы с конвертацией

**Решение:**
1. Убедитесь, что FFmpeg установлен:
   ```bash
   ffmpeg -version
   ```

2. Если FFmpeg не найден, добавьте его в PATH

3. На Windows можно указать путь явно в коде (если нужно)

### Ошибка: "Audio file must be mono" или "Audio file must be uncompressed PCM"

**Решение:**
- Это должно обрабатываться автоматически через pydub
- Убедитесь, что FFmpeg установлен правильно
- Проверьте, что файл аудио не поврежден

### Модель загружается медленно

**Решение:**
- Это нормально при первом запуске
- Модель кэшируется в памяти после первой загрузки
- Для более быстрой загрузки используйте меньшую модель (vosk-model-small-ru-0.22)

### Низкая точность распознавания

**Решение:**
1. Используйте более крупную модель (vosk-model-ru-0.42)
2. Убедитесь, что аудио хорошего качества
3. Говорите четко и не слишком быстро

### Ошибка при установке vosk

**Решение:**
На Windows может потребоваться установить Visual C++ Redistributable:
- https://aka.ms/vs/17/release/vc_redist.x64.exe

## Сравнение с другими провайдерами

| Параметр | Vosk | Yandex SpeechKit | OpenAI Whisper |
|----------|------|------------------|----------------|
| Стоимость | Бесплатно | Платно | Платно |
| Интернет | Не требуется | Требуется | Требуется |
| Точность | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Скорость | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| Приватность | ✅ Полная | ⚠️ На сервере | ⚠️ На сервере |
| Размер модели | 45 МБ - 1.8 ГБ | - | - |

## Рекомендации

- **Для разработки и тестирования:** Используйте `vosk-model-small-ru-0.22` - быстро загружается, достаточно точная
- **Для продакшена:** Используйте `vosk-model-ru-0.42` - лучшая точность
- **Если нужна максимальная точность:** Используйте Yandex SpeechKit или OpenAI Whisper

## Дополнительные ресурсы

- Официальный сайт Vosk: https://alphacephei.com/vosk/
- Модели: https://alphacephei.com/vosk/models
- Документация: https://alphacephei.com/vosk/install
- GitHub: https://github.com/alphacep/vosk-api

