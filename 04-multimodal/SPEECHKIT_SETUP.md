# Инструкция по настройке Yandex SpeechKit

## Шаг 1: Регистрация в Yandex Cloud

1. Перейдите на [Yandex Cloud](https://cloud.yandex.ru/)
2. Создайте аккаунт или войдите в существующий
3. Создайте новый каталог (folder) или используйте существующий

## Шаг 2: Создание сервисного аккаунта

1. Перейдите в раздел **IAM** → **Сервисные аккаунты**
2. Убедитесь, что выбран правильный каталог в выпадающем списке вверху (должен быть `default` или нужный каталог)
3. Нажмите **Создать сервисный аккаунт**
4. Укажите имя (например, `speechkit-bot`)
5. В разделе **Роли** нажмите **Добавить роль**
6. **КРИТИЧЕСКИ ВАЖНО:** При назначении роли:
   - Выберите **Каталог** (Folder) в выпадающем списке "Уровень" или "Scope"
   - **НЕ выбирайте** "Облако" (Cloud) или "Организация" (Organization)
   - Выберите каталог `default` (ID: `b1gmr1r78ff0f9n3qbbk`)
   - Выберите роль **`ai.speechkit-stt.user`** (пользователь SpeechKit)
7. Сохраните сервисный аккаунт

**Важно:** Роль обязательно должна быть назначена на уровне **каталога (folder)**, а не на уровне облака или организации. Это критично для работы SpeechKit API!

## Шаг 3: Получение API-ключа

1. Выберите созданный сервисный аккаунт
2. Перейдите на вкладку **Ключи**
3. Нажмите **Создать новый ключ** → **API-ключ**
4. В поле **Описание** (необязательно) можно указать описание, например: "Для транскрибации голосовых сообщений"
5. В поле **Область действия*** (обязательное поле) выберите:
   - **`yc.ai.speechkitStt.execute`** - это область действия для Speech-to-Text (распознавание речи)
   - Это именно то, что нужно для транскрибации голосовых сообщений
6. В поле **Срок действия** (необязательно) можно указать срок действия ключа или оставить по умолчанию
7. Нажмите **Создать**
8. **КРИТИЧЕСКИ ВАЖНО:** 
   - Скопируйте **полный** API-ключ сразу - он будет показан только один раз!
   - Ключ должен начинаться с `AQVN...` и быть длиной примерно 40-50 символов
   - Убедитесь, что скопировали ключ полностью, без пропусков
   - Проверьте, что в буфере обмена полный ключ (попробуйте вставить в блокнот и проверить длину)
   - Если случайно закрыли диалог - ключ больше недоступен, нужно создать новый!

**Примечание:** Область действия `yc.ai.speechkitStt.execute` дает разрешение на выполнение операций распознавания речи через SpeechKit API. Это работает совместно с ролью `ai.speechkit-stt.user`, назначенной сервисному аккаунту.

## Шаг 4: Получение Folder ID (опционально)

**Важно:** При использовании сервисного аккаунта **не нужно указывать folderId в запросах** к SpeechKit API. Сервис автоматически использует каталог, в котором был создан сервисный аккаунт.

Folder ID может понадобиться для справки или для других целей, но в коде он не используется при запросах через сервисный аккаунт.

Если все же хотите узнать Folder ID:
1. Перейдите в раздел **Каталоги** (в левом меню)
2. Выберите каталог, где создан сервисный аккаунт (обычно это каталог, где назначена роль)
3. Скопируйте **ID каталога** (обычно начинается с `b1g...` или `b1...`)

## Шаг 5: Настройка в проекте

### Вариант 1: Через config.yaml

Откройте `config.yaml` и заполните:

```yaml
speech:
  provider: "yandex"
  api_key: "ваш_api_ключ_здесь"
  folder_id: "ваш_folder_id_здесь"
  language: "ru-RU"
```

### Вариант 2: Через переменные окружения (.env)

Создайте файл `.env` в корне проекта (если его еще нет) и добавьте:

```env
SPEECH_PROVIDER=yandex
SPEECH_API_KEY=ваш_api_ключ_здесь
SPEECH_FOLDER_ID=ваш_folder_id_здесь
SPEECH_LANGUAGE=ru-RU
```

**Важно:** Переменные окружения имеют приоритет над config.yaml

## Шаг 6: Проверка работы

1. Запустите бота:
   ```bash
   make run
   # или
   uv run python -m bot.main
   ```

2. Отправьте голосовое сообщение боту в Telegram
3. Бот должен распознать речь и извлечь транзакцию

## Тарифы Yandex SpeechKit

### Бесплатный тариф
- До **15,000 символов** в месяц бесплатно
- Это примерно **10-15 минут** аудио
- Достаточно для личного использования

### Платный тариф
- После превышения бесплатного лимита: **4 ₽ за 1000 символов**
- Примерно **2.7 ₽ за минуту** аудио

## Устранение проблем

### Ошибка: "Yandex SpeechKit requires API key and Folder ID"

**Решение:** Убедитесь, что вы заполнили `api_key` и `folder_id` в config.yaml или .env

### Ошибка: "Yandex SpeechKit API error: 401"

**Решение:** Проверьте правильность API-ключа

### Ошибка: "API key not found or invalid" (401 Unauthorized)

**Решение (по порядку):**

1. **Проверьте правильность API-ключа:**
   - Убедитесь, что в `config.yaml` указан **полный** API-ключ, который вы скопировали из консоли
   - API-ключ должен начинаться с `AQVN...` и быть длиной примерно 40-50 символов
   - Проверьте, что нет лишних пробелов в начале или конце ключа
   - Убедитесь, что ключ в кавычках в YAML: `api_key: "AQVN..."`
   - **Проверьте текущий ключ в config.yaml:**
     * Откройте `config.yaml`
     * Найдите строку `api_key: "AQVN..."`
     * Убедитесь, что ключ скопирован полностью

2. **Проверьте, что используете правильный API-ключ:**
   - В консоли Yandex Cloud: **IAM** → **Сервисные аккаунты** → `speechkit-bot` → **Ключи**
   - Убедитесь, что идентификатор ключа соответствует тому, что вы создали
   - Если ключ не совпадает, скопируйте правильный ключ из консоли
   - **Важно:** Если вы уже закрыли диалог с ключом, его значение больше не будет показано - нужно создать новый ключ

3. **Пересоздайте API-ключ:**
   - Удалите старый API-ключ в консоли
   - Создайте новый: **Создать новый ключ** → **API-ключ**
   - Область действия: `yc.ai.speechkitStt.execute`
   - **Скопируйте ключ сразу** (он показывается только один раз!)
   - Обновите `api_key` в `config.yaml` с новым значением
   - Убедитесь, что ключ в кавычках и без пробелов

4. **Проверьте назначение роли:**
   - Перейдите: **IAM** → **Сервисные аккаунты** → `speechkit-bot` → вкладка **Роли**
   - Убедитесь, что роль `ai.speechkit-stt.user` назначена на каталог
   - Если роль не назначена, назначьте её на каталог, где создан сервисный аккаунт

5. **Проверьте, что не указываете folderId:**
   - При использовании сервисного аккаунта **не нужно указывать folderId** в запросах
   - SpeechKit автоматически использует каталог сервисного аккаунта

### Ошибка: "Yandex SpeechKit API error: 403"

**Решение:** 
- Убедитесь, что сервисный аккаунт имеет роль `ai.speechkit-stt.user`
- Проверьте, что Folder ID указан правильно
- Убедитесь, что роль назначена на правильный каталог

### Ошибка: "Yandex SpeechKit API error: 400"

**Решение:**
- Проверьте формат аудио (должен быть OGG Opus)
- Убедитесь, что язык указан правильно (`ru-RU`)

## Переключение на другой провайдер

Если хотите использовать OpenAI Whisper API вместо Yandex:

```yaml
speech:
  provider: "openai"
  api_key: "ваш_openai_api_key"
```

Или через переменные окружения:
```env
SPEECH_PROVIDER=openai
SPEECH_API_KEY=ваш_openai_api_key
```

## Дополнительная информация

- [Документация Yandex SpeechKit](https://cloud.yandex.ru/docs/speechkit/)
- [API Reference](https://cloud.yandex.ru/docs/speechkit/stt/api/)
- [Примеры использования](https://cloud.yandex.ru/docs/speechkit/stt/quickstart/)

