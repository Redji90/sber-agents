# Решение проблемы "API key not found or invalid"

## Проблема
При попытке использовать Yandex SpeechKit API получаете ошибку:
```
401 Unauthorized: API key not found or invalid
```

## Диагностика

Выполните тест:
```bash
uv run python test_speechkit.py
```

Если тест показывает ошибку 401, значит проблема в API-ключе.

## Решение

### Шаг 1: Создайте новый API-ключ

1. Перейдите в Yandex Cloud Console:
   - **IAM** → **Сервисные аккаунты** → `speechkit-bot` → **Ключи**

2. Удалите старый ключ (если есть):
   - Нажмите на ключ → **Удалить** → подтвердите

3. Создайте новый ключ:
   - Нажмите **+ Создать новый ключ** → **API-ключ**
   - **Описание**: "Для транскрибации" (опционально)
   - **Область действия***: `yc.ai.speechkitStt.execute` (обязательно!)
   - Нажмите **Создать**

4. **Скопируйте ключ ОЧЕНЬ ВНИМАТЕЛЬНО:**
   - Ключ показывается только один раз!
   - Ключ должен начинаться с `AQVN...`
   - Длина должна быть примерно 40-50 символов
   - Скопируйте полностью, без пропусков
   - Проверьте: вставьте в блокнот и убедитесь, что скопировали полностью

### Шаг 2: Обновите config.yaml

1. Откройте `config.yaml`
2. Найдите строку с `api_key:`
3. Замените значение на новый ключ:
   ```yaml
   speech:
     provider: "yandex"
     api_key: "AQVN...ваш_новый_ключ_здесь..."
     folder_id: "b1gmr1r78ff0f9n3qbbk"
     language: "ru-RU"
   ```
4. Убедитесь, что:
   - Ключ в кавычках
   - Нет лишних пробелов
   - Ключ скопирован полностью

### Шаг 3: Проверьте роль сервисного аккаунта

1. Перейдите: **IAM** → **Сервисные аккаунты** → `speechkit-bot` → **Роли** (или **Права доступа**)
2. Убедитесь, что роль `ai.speechkit-stt.user` назначена на каталог
3. Если роли нет:
   - Нажмите **Назначить роли**
   - Выберите каталог `default` (ID: `b1gmr1r78ff0f9n3qbbk`)
   - Добавьте роль `ai.speechkit-stt.user`
   - Сохраните

### Шаг 4: Проверьте еще раз

1. Запустите тест:
   ```bash
   uv run python test_speechkit.py
   ```

2. Если тест показывает статус 200 или 400 (Bad Request) - это хорошо!
   - Статус 400 означает, что авторизация работает, но нужен реальный аудиофайл
   - Статус 200 означает полный успех

3. Перезапустите бота:
   ```bash
   uv run python -m bot.main
   ```

4. Отправьте голосовое сообщение боту

## Если проблема сохраняется

1. **Проверьте, что используете правильный сервисный аккаунт:**
   - Убедитесь, что сервисный аккаунт называется `speechkit-bot`
   - Проверьте идентификатор сервисного аккаунта: `aje6oi51613pmks58786`

2. **Проверьте область действия API-ключа:**
   - В списке ключей должна быть указана область: `yc.ai.speechkitStt.execute`
   - Если область не указана или указана другая - создайте новый ключ с правильной областью

3. **Проверьте срок действия ключа:**
   - Убедитесь, что ключ не истек
   - Если срок действия близок к истечению, создайте новый ключ

4. **Попробуйте создать ключ без указания области действия:**
   - Иногда помогает создание ключа без явного указания области
   - Но при этом роль `ai.speechkit-stt.user` должна быть назначена

## Дополнительная информация

- API-ключ сервисного аккаунта имеет длину примерно 40-50 символов
- Ключ всегда начинается с `AQVN...`
- После закрытия диалога с ключом его значение больше недоступно
- При использовании сервисного аккаунта не нужно указывать `folderId` в запросах

