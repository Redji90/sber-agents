# Отчет по выполнению ДЗ-8: ReAct Агенты с LangChain

## Реализованный инструмент

### currency_converter

Реализован инструмент конвертации валют `currency_converter`, который позволяет агенту конвертировать суммы между валютами USD, EUR и RUB.

**Функциональность:**
- Конвертация между тремя валютами: USD (доллар США), EUR (евро), RUB (российский рубль)
- Использует фиксированные курсы валют (можно заменить на реальный API)
- Валидация входных данных (проверка валют, положительных сумм)
- Обработка ошибок с понятными сообщениями

**Примеры использования:**
- "Сколько будет 100 долларов в рублях?"
- "Конвертируй 50 евро в доллары"
- "1000 рублей в евро"

**Код инструмента:**
```python
@tool
def currency_converter(amount: float, from_currency: str, to_currency: str) -> str:
    """
    Конвертирует сумму из одной валюты в другую.
    Поддерживаемые валюты: USD, EUR, RUB.
    """
    # Реализация с фиксированными курсами
```

---

## Как агент принимает решения о вызове инструментов

### ReAct паттерн (Reason + Act)

Агент использует паттерн ReAct, который состоит из следующих этапов:

1. **Reason (Рассуждение)**
   - Агент анализирует вопрос пользователя
   - Оценивает контекст диалога (через MemorySaver)
   - Определяет, нужна ли дополнительная информация для ответа

2. **Act (Действие)**
   - Если нужна информация из документов → вызывает `rag_search`
   - Если нужна конвертация валют → вызывает `currency_converter`
   - Если вопрос простой (приветствие, благодарность) → отвечает напрямую без инструментов

3. **Observe (Наблюдение)**
   - Получает результат от инструмента
   - Анализирует полученную информацию

4. **Respond (Ответ)**
   - Формирует финальный ответ на основе:
     - Результатов инструментов (если вызывались)
     - Собственных знаний LLM
     - Контекста диалога

### Примеры принятия решений

**Вопрос: "Привет!"**
- Агент: Рассуждает → Не нужна дополнительная информация → Отвечает напрямую
- Инструменты: Не вызываются

**Вопрос: "Какие условия потребительского кредита?"**
- Агент: Рассуждает → Нужна информация из документов → Вызывает `rag_search`
- Инструменты: `rag_search` → Получает контекст → Формирует ответ

**Вопрос: "Сколько будет 100 долларов в рублях?"**
- Агент: Рассуждает → Нужна конвертация валют → Вызывает `currency_converter`
- Инструменты: `currency_converter` → Получает результат → Формирует ответ

**Вопрос: "Какие условия кредита и сколько будет 1000 долларов в рублях?"**
- Агент: Рассуждает → Нужна информация из документов И конвертация → Вызывает оба инструмента
- Инструменты: `rag_search` → `currency_converter` → Формирует комплексный ответ

### Мониторинг решений

Все решения агента видны в LangSmith:
- **Threads** - история диалога с каждым пользователем
- **Traces** - детальные трейсы каждого шага ReAct цикла
- **Tool calls** - когда и какие инструменты вызывались
- **Messages** - HumanMessage, AIMessage с tool_calls, ToolMessage

---

## Отличия агента от простой RAG-цепочки

### Простая RAG-цепочка

**Характеристики:**
- Всегда вызывает RAG для каждого вопроса
- Нет выбора стратегии - один путь обработки
- Не может использовать дополнительные инструменты
- Не адаптируется под тип вопроса

**Пример работы:**
```
Вопрос → Query Transformation → RAG Search → Ответ
(всегда один и тот же путь)
```

### ReAct Агент

**Характеристики:**
- Самостоятельно решает, нужен ли поиск в документах
- Может использовать несколько инструментов
- Адаптируется под тип вопроса
- Может отвечать напрямую без инструментов

**Пример работы:**
```
Вопрос → Анализ → Решение:
  ├─ Простой вопрос → Прямой ответ (без инструментов)
  ├─ Вопрос о документах → rag_search → Ответ
  ├─ Вопрос о валюте → currency_converter → Ответ
  └─ Комплексный вопрос → Несколько инструментов → Ответ
```

### Ключевые отличия

| Характеристика | RAG-цепочка | ReAct Агент |
|----------------|-------------|-------------|
| **Вызов RAG** | Всегда | Только при необходимости |
| **Инструменты** | Только RAG | Множество инструментов |
| **Простые вопросы** | Все равно ищет в документах | Отвечает напрямую |
| **Адаптивность** | Нет | Да |
| **Сложность** | Проще | Сложнее |
| **Латентность** | Всегда одинаковая | Может быть быстрее (без RAG) |

### Практические примеры

**Вопрос: "Спасибо за помощь"**
- RAG-цепочка: Ищет в документах → Не находит → "Я не нашел ответа..."
- Агент: Отвечает напрямую → "Пожалуйста, обращайтесь!"

**Вопрос: "Какие условия кредита?"**
- RAG-цепочка: Ищет в документах → Находит → Отвечает
- Агент: Решает что нужен поиск → Ищет → Отвечает (тот же результат, но с пониманием)

**Вопрос: "100 долларов в рублях"**
- RAG-цепочка: Ищет в документах → Не находит → "Я не нашел ответа..."
- Агент: Решает что нужна конвертация → Вызывает `currency_converter` → Отвечает

---

## Преимущества и ограничения

### Преимущества ReAct Агента

1. **Автономность принятия решений**
   - Агент сам выбирает стратегию обработки вопроса
   - Не требует ручной настройки сценариев для каждого типа вопроса
   - Адаптируется к новым типам вопросов

2. **Эффективность**
   - Не тратит ресурсы на поиск для простых вопросов
   - Быстрее отвечает на приветствия и благодарности
   - Оптимизирует использование инструментов

3. **Расширяемость**
   - Легко добавлять новые инструменты
   - Агент автоматически учится их использовать
   - Не требует изменения логики обработки вопросов

4. **Гибкость**
   - Может комбинировать несколько инструментов
   - Обрабатывает комплексные вопросы
   - Адаптируется под контекст диалога

5. **Прозрачность**
   - Все решения видны в LangSmith
   - Можно анализировать логику принятия решений
   - Легко отлаживать и улучшать

### Ограничения и проблемы

1. **Сложность отладки**
   - Сложнее понять, почему агент принял то или иное решение
   - Нужны инструменты мониторинга (LangSmith)
   - Требуется больше времени на анализ работы

2. **Непредсказуемость**
   - Агент может принять неожиданное решение
   - Может не вызвать инструмент, когда нужно
   - Может вызвать инструмент, когда не нужно

3. **Зависимость от качества LLM**
   - Качество решений зависит от модели
   - Более слабые модели могут принимать неверные решения
   - Требуются более мощные (и дорогие) модели

4. **Латентность**
   - ReAct цикл может быть медленнее для простых вопросов
   - Несколько вызовов инструментов увеличивают время ответа
   - Требуется больше API вызовов к LLM

5. **Стоимость**
   - Больше вызовов к LLM (каждый шаг рассуждения)
   - Использование более мощных моделей
   - Больше токенов в промптах

6. **Проблемы с evaluation**
   - Метрики RAGAS могут быть `nan` при ошибках в моделях
   - Сложнее оценить качество работы агента
   - Требуется тщательная настройка моделей для evaluation

### Сравнение с RAG-цепочкой

**Когда использовать RAG-цепочку:**
- Простые задачи с одним источником информации
- Предсказуемые сценарии использования
- Ограниченные ресурсы (бюджет, время)
- Нужна стабильность и предсказуемость

**Когда использовать ReAct Агента:**
- Комплексные задачи с несколькими источниками
- Нужна адаптивность и гибкость
- Есть бюджет на более мощные модели
- Нужна расширяемость (множество инструментов)

---

## Выводы

ReAct агент предоставляет мощный инструмент для создания интеллектуальных ассистентов, которые могут:
- Самостоятельно принимать решения
- Использовать множество инструментов
- Адаптироваться под разные типы вопросов
- Обрабатывать комплексные запросы

Однако это требует:
- Более мощных моделей LLM
- Инструментов мониторинга (LangSmith)
- Тщательной настройки и тестирования
- Большего бюджета на API вызовы

Для простых задач RAG-цепочка может быть более эффективным решением, но для сложных сценариев с множеством инструментов ReAct агент - оптимальный выбор.

---

## Технические детали реализации

**Использованные технологии:**
- LangChain 1.0 `create_agent()` - упрощенный API для создания агентов
- LangGraph MemorySaver - сохранение истории диалогов
- LangChain Tools - декоратор `@tool` для создания инструментов
- LangSmith - мониторинг и трейсинг работы агента

**Архитектура:**
- `src/agent.py` - создание и управление агентом
- `src/tools.py` - определение инструментов (rag_search, currency_converter)
- `src/handlers.py` - обработка сообщений Telegram и вызов агента
- `prompts/agent_system.txt` - системный промпт с инструкциями для агента

**Конфигурация:**
- Модель агента: `openai/gpt-oss-20b` (через Groq API)
- Retrieval mode: `hybrid_reranker` (Semantic + BM25 + Cross-encoder)
- Embeddings: HuggingFace `intfloat/multilingual-e5-base`

