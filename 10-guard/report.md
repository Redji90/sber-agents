# Отчет по ДЗ-10: Безопасность агентных систем

## Реализованные механизмы безопасности

### 1. Маскирование чувствительных данных (PII)
- Добавлен `PIIMasker` (используется в обработчиках бота) для маскирования чувствительных данных в сообщениях пользователей и ответах бота
- Маскируются:
  - номера кредитных карт (показываются только последние 4 цифры),
  - номера телефонов,
  - email‑адреса,
  - номера паспортов,
  - ИНН,
  - СНИЛС

### 2. Лимиты на вызовы
- `ModelCallLimitMiddleware`: лимит **10** вызовов модели на одного пользователя за **1 час**
- `ToolCallLimitMiddleware`: лимит **20** вызовов инструментов на одного пользователя за **1 час**

### 3. Human-in-the-Loop
- Инструменты, требующие подтверждения пользователя перед выполнением:
  - `open_credit_card` — открытие кредитной/дебетовой карты
  - `open_deposit` — открытие нового вклада

### 4. Дополнительные фильтры (опционально)
- Дополнительных фильтров уровня LLM Guard не добавлялось; основной упор сделан на:
  - маскирование PII до и после вызова модели,
  - HITL для критичных операций,
  - ограничение частоты вызовов модели и инструментов

## Сложности и решения

- **Несовместимость отдельных возможностей LangChain с текущей версией**  
  Класс `BaseAgentMiddleware` оказался недоступен, из-за чего изначальная реализация PIIMiddleware «как middleware агента» не заработала.  
  Решение: вынести маскирование PII в отдельный модуль `PIIMasker` и вызывать его напрямую из `handlers.py` перед отправкой текста в модель и перед отправкой ответа пользователю.

- **Ошибки в регулярных выражениях и краши при маскировании телефонов**  
  Первые версии шаблонов для телефонов и ИНН приводили к ошибкам `tuple index out of range`.  
  Решение: переписать регулярные выражения и добавить проверки количества групп/длины строки, покрыв типичные российские форматы.

- **Проблемы с валидацией инструментов у LLM‑провайдера (Groq)**  
  Модель несколько раз возвращала ошибки `tool_use_failed` при попытке вызвать MCP‑инструменты, которых не было в `request.tools`.  
  Решение: жёстко отфильтровать список инструментов, передаваемых модели, и оставить только действительно используемые (`rag_search` + критичные операции); для нового инструмента `open_deposit` добавить локальный вариант, чтобы не зависеть от ограничений MCP/провайдера.

- **Конфликты нескольких экземпляров Telegram‑бота и сетевые ошибки**  
  При параллельных запусках возникали `TelegramConflictError` и ошибки подключения к `api.telegram.org`.  
  Решение: перед каждым запуском останавливать все процессы `python`, связанные с проектом, и запускать ровно один экземпляр бота; добавить обработку сетевых ошибок и повторные попытки в логике aiogram.

## Инсайты

- Даже простой агент, подключённый к внешним инструментам, быстро превращается в «критичную систему», если он может открывать продукты банка — без HITL и лимитов это небезопасно как технически, так и организационно.
- На практике удобнее реализовывать безопасность «по слоям»: сначала PII‑маскирование, затем HITL для операций с деньгами, затем rate limiting; каждая из этих мер по отдельности полезна, но вместе они дают заметно более устойчивую и предсказуемую систему.



